<% content_for :stylesheets do %>
  <%= stylesheet_link_tag "calendar" %> <!--app/stylesheets/calendar.cssを読み込む-->
<% end %>

<div class="calendar-page">
  <div class="calendar-header">
    <div class="calendar-title">
      <h1><%= @date.strftime("%Y年%-m月") %></h1>
      <div class="notification-controls">
        <% if current_user.notification&.enabled? %>
          <%= button_to "通知を無効にする",
                  notification_path,
                  method: :patch,
                  params: { notification: { enabled: false } },
                  class: "notification-btn enabled" %>
        <% else %>
          <%= button_to "通知を有効にする",
                  notification_path,
                  method: :patch,
                  params: { notification: { enabled: true } },
                  class: "notification-btn disabled" %>
        <% end %>
      </div>
    </div>
    
    <div class="account-links">
      <a href="<%= destroy_user_session_path %>" data-turbo-method="delete" class="logout-btn">ログアウト</a><br>
      <%= link_to "〔アカウント編集・削除〕", edit_user_path(current_user), class: "account-edit-link" %>
      <%= link_to "〔買い物リスト〕", shopping_lists_path, class: "shopping-lists-link" %>
      <%= link_to "新しい予定を作成", new_plan_path, class: "new-plan-btn" %>
    </div>
  </div>

 <%= month_calendar class: "simple-calendar", events: @plans, start_day: :sunday do |date, events_for_date| %>
    <% day_class = "day" %>
    <% day_class += " today" if date == Date.today %>
    <% day_class += " sunday" if date.sunday? %>
    <% day_class += " saturday" if date.saturday? %>
    <% day_class += " other-month" if @date && date.month != @date.month %>

    <div class="<%= day_class %>">
      <%= date.day %>
      
      <div class="rokuyou">
        <%= rokuyou(date) %>
      </div>

      <% if @shopping_counts[date].present? %>
        <%= link_to "+", new_shopping_list_path(date: date), class: "add-button" %>
        <%= link_to "#{@shopping_counts[date]}件", shopping_lists_path(date: date), class: "shopping-count-link" %>
      <% else %>
        <%= link_to "+", new_shopping_list_path(date: date), class: "add-button" %>
      <% end %>
    </div>
    <%= render partial: "plans/plan", locals: { plans_for_date: @plans.select { |p| p.start_time.to_date == date } } %>
  <% end %>
</div>

<!--通知バナー-->
<div id="banner-container">
  <% if @today_lists.present? %>
    <div class="banner" id="banner-list">
      🛒 今日の買い物リストがあります
      <%= link_to "見る", today_shopping_lists_path, class: "btn" %>
    </div>
  <% end %>

  <% if @today_plans.present? %>
    <div class="banner" id="banner-plan">
      📅 今日の予定があります
      <%= link_to "見る", today_plans_path, class: "btn" %>
    </div>
  <% end %>
</div>

<script>
window.addEventListener('turbo:load', () => {
  const banners = document.querySelectorAll('.banner');
  banners.forEach(banner => {
    setTimeout(() => {
      banner.classList.add('visible')}, 1500);
    setTimeout(() => {
      banner.classList.remove('visible');
      setTimeout(() => banner.style.display = 'none', 2000);
    }, 5000);
  });
});
</script>
